pipeline {
    agent any

    environment {
        // Tên file docker-compose để dùng cho build và deploy
        COMPOSE_FILE = 'docker-compose.yml'

        // Tên project Docker Compose, giúp gom các container cùng prefix (vd: chatapp-backend-1)
        PROJECT_NAME = 'chatapp'

        // Thư mục backend trong repo (nơi chứa code NestJS)
        BACKEND_DIR = 'backend'

        // Tạo tên migration tự động kèm timestamp để không trùng
        MIGRATION_NAME = "AutoGenerated$(date +%s)"
    }

    stages {
        // --- 1️⃣ Checkout code từ GitHub ---
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/duykhanhdeveloper93/chatApp3'
            }
        }

        // --- 2️⃣ Sinh migration tự động nếu entity thay đổi ---
        stage('Generate Migration') {
            steps {
                dir("${BACKEND_DIR}") {
                    sh '''
                        echo "📦 Cài dependency để chạy TypeORM CLI..."
                        npm install

                        echo "🧠 Sinh migration mới (nếu có thay đổi entity)..."
                        npx typeorm migration:generate -d data-source.ts src/migrations/$MIGRATION_NAME || echo "⚠️ Không có thay đổi nào để generate"
                    '''
                }
            }
        }

        // --- 3️⃣ Build Docker images cho FE & BE ---
        stage('Build Docker Images') {
            steps {
                sh '''
                    echo "⚙️ Đang build Docker images (có cache để build nhanh hơn)..."
                    docker-compose -p $PROJECT_NAME -f $COMPOSE_FILE build
                '''
            }
        }

        // --- 4️⃣ Deploy containers + chạy migration trong container backend ---
        stage('Deploy & Run Migration') {
            steps {
                sh '''
                    echo "🧹 Xóa các container cũ để tránh conflict..."
                    docker-compose -p $PROJECT_NAME -f $COMPOSE_FILE down --remove-orphans || true

                    echo "🗑️ Xóa container trùng tên nếu còn sót..."
                    docker ps -a --filter "name=${PROJECT_NAME}" -q | xargs -r docker rm -f || true
                    docker ps -a --filter "name=chat-" -q | xargs -r docker rm -f || true

                    echo "🚀 Khởi động các container mới..."
                    docker-compose -p $PROJECT_NAME -f $COMPOSE_FILE up -d

                    echo "⚙️ Chạy TypeORM migration trong container backend..."
                    docker exec ${PROJECT_NAME}-backend-1 npx typeorm migration:run -d dist/data-source.js || echo "⚠️ Bỏ qua nếu không có migration"
                '''
            }
        }
    }

    // --- 5️⃣ Báo kết quả ---
    post {
        success {
            echo '✅ Triển khai thành công!'
        }
        failure {
            echo '❌ Triển khai thất bại!'
        }
    }
}
