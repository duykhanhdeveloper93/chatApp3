pipeline {
    agent any

    environment {
        // TÃªn file docker-compose Ä‘á»ƒ dÃ¹ng cho build vÃ  deploy
        COMPOSE_FILE = 'docker-compose.yml'

        // TÃªn project Docker Compose, giÃºp gom cÃ¡c container cÃ¹ng prefix (vd: chatapp-backend-1)
        PROJECT_NAME = 'chatapp'

        // ThÆ° má»¥c backend trong repo (nÆ¡i chá»©a code NestJS)
        BACKEND_DIR = 'backend'

        // Táº¡o tÃªn migration tá»± Ä‘á»™ng kÃ¨m timestamp Ä‘á»ƒ khÃ´ng trÃ¹ng
        MIGRATION_NAME = "AutoGenerated$(date +%s)"
    }

    stages {
        // --- 1ï¸âƒ£ Checkout code tá»« GitHub ---
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/duykhanhdeveloper93/chatApp3'
            }
        }

        // --- 2ï¸âƒ£ Sinh migration tá»± Ä‘á»™ng náº¿u entity thay Ä‘á»•i ---
        stage('Generate Migration') {
            steps {
                dir("${BACKEND_DIR}") {
                    sh '''
                        echo "ğŸ“¦ CÃ i dependency Ä‘á»ƒ cháº¡y TypeORM CLI..."
                        npm install

                        echo "ğŸ§  Sinh migration má»›i (náº¿u cÃ³ thay Ä‘á»•i entity)..."
                        npx typeorm migration:generate -d data-source.ts src/migrations/$MIGRATION_NAME || echo "âš ï¸ KhÃ´ng cÃ³ thay Ä‘á»•i nÃ o Ä‘á»ƒ generate"
                    '''
                }
            }
        }

        // --- 3ï¸âƒ£ Build Docker images cho FE & BE ---
        stage('Build Docker Images') {
            steps {
                sh '''
                    echo "âš™ï¸ Äang build Docker images (cÃ³ cache Ä‘á»ƒ build nhanh hÆ¡n)..."
                    docker-compose -p $PROJECT_NAME -f $COMPOSE_FILE build
                '''
            }
        }

        // --- 4ï¸âƒ£ Deploy containers + cháº¡y migration trong container backend ---
        stage('Deploy & Run Migration') {
            steps {
                sh '''
                    echo "ğŸ§¹ XÃ³a cÃ¡c container cÅ© Ä‘á»ƒ trÃ¡nh conflict..."
                    docker-compose -p $PROJECT_NAME -f $COMPOSE_FILE down --remove-orphans || true

                    echo "ğŸ—‘ï¸ XÃ³a container trÃ¹ng tÃªn náº¿u cÃ²n sÃ³t..."
                    docker ps -a --filter "name=${PROJECT_NAME}" -q | xargs -r docker rm -f || true
                    docker ps -a --filter "name=chat-" -q | xargs -r docker rm -f || true

                    echo "ğŸš€ Khá»Ÿi Ä‘á»™ng cÃ¡c container má»›i..."
                    docker-compose -p $PROJECT_NAME -f $COMPOSE_FILE up -d

                    echo "âš™ï¸ Cháº¡y TypeORM migration trong container backend..."
                    docker exec ${PROJECT_NAME}-backend-1 npx typeorm migration:run -d dist/data-source.js || echo "âš ï¸ Bá» qua náº¿u khÃ´ng cÃ³ migration"
                '''
            }
        }
    }

    // --- 5ï¸âƒ£ BÃ¡o káº¿t quáº£ ---
    post {
        success {
            echo 'âœ… Triá»ƒn khai thÃ nh cÃ´ng!'
        }
        failure {
            echo 'âŒ Triá»ƒn khai tháº¥t báº¡i!'
        }
    }
}
