pipeline {
    agent any

    environment {
        COMPOSE_FILE = 'docker-compose.yml'
        PROJECT_NAME = 'chatapp'
        BACKEND_DIR = 'backend'
    }

    stages {

        stage('Checkout') {
            steps {
                echo "ðŸ“¥ Láº¥y source code tá»« GitHub..."
                git branch: 'main',
                    url: 'https://github.com/duykhanhdeveloper93/chatApp3'
            }
        }

        stage('Install Dependencies') {
            steps {
                dir("${BACKEND_DIR}") {
                    sh '''
                        echo "ðŸ“¦ CÃ i Ä‘áº·t dependencies cho backend..."
                        npm install
                    '''
                }
            }
        }

        stage('Start Temporary MySQL for Migration') {
            steps {
                sh '''
                    echo "ðŸ³ Khá»Ÿi Ä‘á»™ng táº¡m MySQL container..."
                    docker-compose -p $PROJECT_NAME -f $COMPOSE_FILE up -d mysql

                    echo "â³ Äá»£i MySQL khá»Ÿi Ä‘á»™ng..."
                    sleep 15
                '''
            }
        }

        stage('Generate Migration') {
            steps {
                dir("${BACKEND_DIR}") {
                    sh '''
                        echo "ðŸ§  Sinh migration má»›i..."

                        # âœ… Táº¡o file .env táº¡m cho Jenkins (sá»­ dá»¥ng localhost Ä‘á»ƒ káº¿t ná»‘i MySQL)
                        cat > .env <<EOF
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=chat_user
DB_PASSWORD=chat_password
DB_NAME=chat_app_dev

NODE_ENV=development
JWT_SECRET=2f1a92a1a6d8481fb9f60e6a5e8d7f79b42e6ef6a9243c1d8d0f4f2a9c3b7d88

RABBITMQ_DEFAULT_USER=chat_user
RABBITMQ_DEFAULT_PASS=chat_password
RABBITMQ_PORT=5672
RABBITMQ_MANAGEMENT_PORT=15672
RABBITMQ_HOST=rabbitmq
REDIS_HOST=redis
REDIS_PORT=6379
EOF

                        echo "ðŸ“„ Náº¡p biáº¿n mÃ´i trÆ°á»ng tá»« .env"
                        export $(grep -v '^#' .env | xargs)

                        MIGRATION_NAME="AutoGenerated$(date +%s)"
                        npx ts-node -r tsconfig-paths/register ./node_modules/typeorm/cli.js migration:generate \
                            -d src/data-source.ts src/migrations/$MIGRATION_NAME \
                            || echo "âš ï¸ KhÃ´ng cÃ³ thay Ä‘á»•i nÃ o Ä‘á»ƒ generate"
                    '''
                }
            }
        }

        stage('Build & Deploy Containers') {
            steps {
                sh '''
                    echo "ðŸš€ Build & khá»Ÿi Ä‘á»™ng láº¡i toÃ n bá»™ project..."
                    docker-compose -p $PROJECT_NAME -f $COMPOSE_FILE up -d --build

                    echo "â³ Äá»£i backend sáºµn sÃ ng Ä‘á»ƒ cháº¡y migration..."
                    sleep 15

                    echo "âš™ï¸ Cháº¡y migration trong container backend..."
                    docker exec chat-backend npx typeorm migration:run -d dist/data-source.js \
                        || echo "âš ï¸ KhÃ´ng cÃ³ migration nÃ o Ä‘á»ƒ cháº¡y"
                '''
            }
        }
    }

    post {
        success {
            echo 'âœ… Triá»ƒn khai thÃ nh cÃ´ng!'
            sh '''
                docker image prune -f
                docker builder prune -f
            '''
        }
        failure {
            echo 'âŒ Triá»ƒn khai tháº¥t báº¡i! Kiá»ƒm tra log Ä‘á»ƒ biáº¿t chi tiáº¿t.'
            sh '''
                echo "ðŸ§¹ Dá»«ng cÃ¡c container táº¡m..."
                docker-compose -p $PROJECT_NAME -f $COMPOSE_FILE down || true
            '''
        }
        always {
            echo "ðŸ Pipeline hoÃ n táº¥t."
        }
    }
}
